<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auto Lecture App - Frontend</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .main-content {
        padding: 30px;
      }

      .section {
        margin-bottom: 30px;
        padding: 25px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        background: #fafafa;
      }

      .section h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.5em;
        display: flex;
        align-items: center;
      }

      .section h2::before {
        content: "";
        display: inline-block;
        width: 4px;
        height: 25px;
        background: #4facfe;
        margin-right: 15px;
        border-radius: 2px;
      }

      .upload-area {
        border: 3px dashed #ccc;
        border-radius: 10px;
        padding: 40px;
        text-align: center;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .upload-area:hover {
        border-color: #4facfe;
        background: #f8fffe;
      }

      .upload-area.dragover {
        border-color: #00f2fe;
        background: #e8f8ff;
      }

      .file-input {
        display: none;
      }

      .upload-text {
        font-size: 1.1em;
        color: #666;
        margin-bottom: 10px;
      }

      .file-list {
        margin-top: 20px;
        text-align: left;
      }

      .file-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-bottom: 5px;
      }

      .file-name {
        font-weight: bold;
        color: #333;
      }

      .file-size {
        color: #666;
        font-size: 0.9em;
      }

      .remove-btn {
        background: #ff4757;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 0.8em;
      }

      .remove-btn:hover {
        background: #ff3742;
      }

      .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .config-item {
        display: flex;
        flex-direction: column;
      }

      .config-item label {
        font-weight: bold;
        margin-bottom: 5px;
        color: #333;
      }

      .config-item input,
      .config-item select {
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 1em;
      }

      .config-item input:focus,
      .config-item select:focus {
        outline: none;
        border-color: #4facfe;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }

      .checkbox-item input[type="checkbox"] {
        margin-right: 10px;
        transform: scale(1.2);
      }

      .btn {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .btn-secondary:hover {
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .status {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-weight: bold;
        display: none;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #4facfe;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .results {
        margin-top: 30px;
        display: none;
      }

      .result-item {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-bottom: 20px;
        overflow: hidden;
      }

      .result-header {
        background: #f8f9fa;
        padding: 15px;
        border-bottom: 1px solid #ddd;
        font-weight: bold;
        color: #333;
      }

      .result-content {
        padding: 20px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
        line-height: 1.4;
      }

      .cost-info {
        background: #fff3cd;
        color: #856404;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
        font-weight: bold;
      }

      .api-status {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 10px 15px;
        border-radius: 5px;
        font-weight: bold;
        z-index: 1000;
      }

      .api-status.online {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .api-status.offline {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .file-item {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .file-info {
        flex-grow: 1;
      }

      .file-name {
        font-weight: bold;
        color: #495057;
        margin-bottom: 5px;
      }

      .file-meta {
        font-size: 0.9em;
        color: #6c757d;
      }

      .file-actions {
        display: flex;
        gap: 10px;
      }

      .btn-file {
        padding: 5px 10px;
        font-size: 0.8em;
        border-radius: 3px;
        text-decoration: none;
        color: white;
        cursor: pointer;
        border: none;
      }

      .btn-view {
        background: #17a2b8;
      }

      .btn-download {
        background: #28a745;
      }

      .markdown-content {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        line-height: 1.6;
        color: #333;
      }

      .markdown-content h1,
      .markdown-content h2,
      .markdown-content h3 {
        color: #2c3e50;
        margin-top: 20px;
        margin-bottom: 10px;
      }

      .markdown-content pre {
        background: #f4f4f4;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
      }

      @media (max-width: 768px) {
        .container {
          margin: 10px;
        }

        .main-content {
          padding: 20px;
        }

        .config-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div id="apiStatus" class="api-status offline">üî¥ API Offline</div>

    <div class="container">
      <div class="header">
        <h1>üéì Auto Lecture App</h1>
        <p
          >Upload your lecture PDFs and generate comprehensive study materials
          with AI</p
        >
      </div>

      <div class="main-content">
        <!-- Status Messages -->
        <div id="statusMessage" class="status"></div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading">
          <div class="spinner"></div>
          <p>Processing your lectures... This may take a few minutes.</p>
        </div>

        <!-- File Upload Section -->
        <div class="section">
          <h2>üìÅ Upload PDF Files</h2>
          <div
            class="upload-area"
            onclick="document.getElementById('fileInput').click()"
          >
            <div class="upload-text">
              <strong>Click here or drag and drop PDF files</strong><br />
              Multiple files supported
            </div>
            <input
              type="file"
              id="fileInput"
              class="file-input"
              multiple
              accept=".pdf"
            />
          </div>
          <div id="fileList" class="file-list"></div>
        </div>

        <!-- Configuration Section -->
        <div class="section">
          <h2>‚öôÔ∏è Configuration</h2>
          <div class="config-grid">
            <div class="config-item">
              <label for="model">AI Model</label>
              <select id="model">
                <option value="gpt-4o-mini">GPT-4o Mini (Recommended)</option>
                <option value="gpt-4o">GPT-4o</option>
                <option value="gpt-4.1-mini">GPT-4.1 Mini</option>
              </select>
            </div>
            <div class="config-item">
              <label for="startLecture">Start Lecture #</label>
              <input type="number" id="startLecture" value="1" min="0" />
            </div>
            <div class="config-item">
              <label for="numLectures">Number of Lectures</label>
              <input type="number" id="numLectures" value="100" min="1" />
            </div>
            <div class="config-item">
              <label for="maxConcurrent">Max Concurrent Calls</label>
              <input
                type="number"
                id="maxConcurrent"
                value="3"
                min="1"
                max="10"
              />
            </div>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="getTranscripts" checked />
            <label for="getTranscripts">Generate Lecture Transcripts</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="getQA" checked />
            <label for="getQA">Generate Questions & Answers</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="getKeyPoints" checked />
            <label for="getKeyPoints">Generate Key Points</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="isBook" />
            <label for="isBook">Content is from a book (not lectures)</label>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="section">
          <h2>üöÄ Actions</h2>

          <div style="margin-bottom: 20px">
            <h3 style="margin-bottom: 10px; color: #666"
              >Step-by-Step Processing:</h3
            >
            <button class="btn" onclick="mergePdfs()" id="mergeBtn">
              üìÑ 1. Merge PDFs
            </button>
            <button
              class="btn"
              onclick="extractContent()"
              id="extractBtn"
              disabled
            >
              üìù 2. Extract Content
            </button>
            <button class="btn" onclick="processWithAI()" id="aiBtn" disabled>
              ü§ñ 3. Process with AI
            </button>
          </div>

          <div style="margin-bottom: 20px">
            <h3 style="margin-bottom: 10px; color: #666">Complete Pipeline:</h3>
            <button
              class="btn"
              onclick="processCompletePipeline()"
              id="processBtn"
            >
              üéØ Process Complete Pipeline
            </button>
          </div>

          <div>
            <h3 style="margin-bottom: 10px; color: #666">Utilities:</h3>
            <button class="btn btn-secondary" onclick="updateConfig()">
              ‚öôÔ∏è Update Configuration
            </button>
            <button class="btn btn-secondary" onclick="checkApiStatus()">
              üîÑ Check API Status
            </button>
            <button class="btn btn-secondary" onclick="clearResults()">
              üóëÔ∏è Clear Results
            </button>
            <button class="btn btn-secondary" onclick="showDebugInfo()">
              üêõ Debug Info
            </button>
            <button class="btn btn-secondary" onclick="viewTempFiles()">
              üìÅ View Generated Files
            </button>
          </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="results section">
          <h2>üìä Results</h2>
          <div id="costInfo" class="cost-info"></div>
          <div id="resultsList"></div>
        </div>

        <!-- Debug Info Section -->
        <div id="debugInfo" class="section" style="display: none">
          <h2>üêõ Debug Information</h2>
          <div
            id="debugContent"
            style="
              background: #f8f9fa;
              padding: 15px;
              border-radius: 5px;
              font-family: monospace;
              font-size: 0.9em;
              white-space: pre-wrap;
              max-height: 400px;
              overflow-y: auto;
            "
          ></div>
        </div>

        <!-- Temp Files Section -->
        <div id="tempFiles" class="section" style="display: none">
          <h2>üìÅ Generated Files</h2>
          <div id="tempFilesList"></div>
          <div id="fileViewer" style="display: none; margin-top: 20px">
            <h3 id="viewerTitle">File Content</h3>
            <div
              id="fileContent"
              style="
                background: #f8f9fa;
                padding: 15px;
                border-radius: 5px;
                max-height: 500px;
                overflow-y: auto;
                border: 1px solid #ddd;
              "
            ></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:8000/api/v1";
      let uploadedFiles = [];
      let mergedPdfData = null;
      let extractedLectures = null;
      let debugLog = [];

      // Debug logging function
      function addDebugLog(message, data = null) {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = `[${timestamp}] ${message}`;
        debugLog.push(logEntry);
        if (data) {
          debugLog.push(JSON.stringify(data, null, 2));
        }
        console.log(logEntry, data);
      }

      // Initialize the app
      document.addEventListener("DOMContentLoaded", function () {
        setupFileUpload();
        checkApiStatus();

        // Check API status every 30 seconds
        setInterval(checkApiStatus, 30000);
      });

      // File upload functionality
      function setupFileUpload() {
        const uploadArea = document.querySelector(".upload-area");
        const fileInput = document.getElementById("fileInput");

        // Drag and drop
        uploadArea.addEventListener("dragover", (e) => {
          e.preventDefault();
          uploadArea.classList.add("dragover");
        });

        uploadArea.addEventListener("dragleave", () => {
          uploadArea.classList.remove("dragover");
        });

        uploadArea.addEventListener("drop", (e) => {
          e.preventDefault();
          uploadArea.classList.remove("dragover");
          handleFiles(e.dataTransfer.files);
        });

        // File input change
        fileInput.addEventListener("change", (e) => {
          handleFiles(e.target.files);
        });
      }

      function handleFiles(files) {
        for (let file of files) {
          // Enhanced file validation
          if (
            file.type === "application/pdf" ||
            file.name.toLowerCase().endsWith(".pdf")
          ) {
            // Check file size (max 50MB)
            const maxSize = 50 * 1024 * 1024; // 50MB in bytes
            if (file.size > maxSize) {
              showStatus(
                "error",
                `${file.name} is too large (${formatFileSize(
                  file.size
                )}). Maximum size is 50MB.`
              );
              addDebugLog(
                `File rejected: ${file.name} - Size: ${file.size} bytes (>${maxSize})`
              );
              continue;
            }

            // Check if file is empty
            if (file.size === 0) {
              showStatus(
                "error",
                `${file.name} is empty and cannot be processed.`
              );
              addDebugLog(`File rejected: ${file.name} - Empty file`);
              continue;
            }

            // Check if file already exists
            if (!uploadedFiles.find((f) => f.name === file.name)) {
              uploadedFiles.push(file);
              addDebugLog(
                `File added: ${file.name} - Size: ${formatFileSize(file.size)}`
              );
            } else {
              showStatus("info", `${file.name} is already in the upload list.`);
            }
          } else {
            showStatus(
              "error",
              `${file.name} is not a PDF file and will be ignored. Only PDF files are supported.`
            );
            addDebugLog(
              `File rejected: ${file.name} - Invalid type: ${file.type}`
            );
          }
        }
        updateFileList();
        updateProcessButton();
      }

      function updateFileList() {
        const fileList = document.getElementById("fileList");

        if (uploadedFiles.length === 0) {
          fileList.innerHTML = "";
          return;
        }

        fileList.innerHTML = uploadedFiles
          .map(
            (file, index) => `
                <div class="file-item">
                    <div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(
                          file.size
                        )}</div>
                    </div>
                    <button class="remove-btn" onclick="removeFile(${index})">Remove</button>
                </div>
            `
          )
          .join("");
      }

      function removeFile(index) {
        uploadedFiles.splice(index, 1);
        updateFileList();
        updateProcessButton();
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      function updateProcessButton() {
        const processBtn = document.getElementById("processBtn");
        const mergeBtn = document.getElementById("mergeBtn");
        const extractBtn = document.getElementById("extractBtn");
        const aiBtn = document.getElementById("aiBtn");

        // Complete pipeline button
        processBtn.disabled = uploadedFiles.length === 0;

        // Step-by-step buttons
        mergeBtn.disabled = uploadedFiles.length === 0;
        extractBtn.disabled = !mergedPdfData;
        aiBtn.disabled = !extractedLectures;
      }

      // API Functions
      async function checkApiStatus() {
        const statusDiv = document.getElementById("apiStatus");

        addDebugLog("Checking API status...");

        try {
          const response = await fetch("http://localhost:8000/health");
          if (response.ok) {
            statusDiv.textContent = "üü¢ API Online";
            statusDiv.className = "api-status online";
            addDebugLog("‚úÖ API is online");
          } else {
            throw new Error(`API responded with status: ${response.status}`);
          }
        } catch (error) {
          statusDiv.textContent = "üî¥ API Offline";
          statusDiv.className = "api-status offline";
          addDebugLog("‚ùå API is offline", { error: error.message });
          console.error("API Status Error:", error);
        }
      }

      // Enhanced error handling function
      function handleApiError(error, response = null, context = "") {
        addDebugLog(`‚ùå Error in ${context}`, {
          error: error.message,
          stack: error.stack,
          response: response
            ? {
                status: response.status,
                statusText: response.statusText,
                url: response.url,
              }
            : null,
        });

        let errorMessage = `Error in ${context}: ${error.message}`;

        if (response) {
          if (response.status === 404) {
            errorMessage +=
              "\nüîç Possible causes:\n- Backend not running\n- Incorrect API endpoint\n- Check if server is on localhost:8000";
          } else if (response.status === 422) {
            errorMessage +=
              "\nüìù Possible causes:\n- Invalid input data\n- Missing required fields\n- Check file format (must be PDF)";
          } else if (response.status === 429) {
            errorMessage +=
              "\n‚è±Ô∏è Rate limit exceeded\n- Too many API calls\n- Wait a moment and try again\n- Reduce concurrent calls";
          } else if (response.status === 500) {
            errorMessage +=
              "\nüîß Server error\n- Check backend logs\n- Verify OpenAI API key\n- Check file content validity";
          } else if (response.status === 400) {
            if (error.message.includes("Failed to open file")) {
              errorMessage +=
                "\nüìÑ PDF File Error:\n- File may be corrupted or password-protected\n- Try with a different PDF file\n- Ensure PDF is not currently open in another application\n- Check if file is a valid PDF format";
            } else if (error.message.includes("No valid PDF content")) {
              errorMessage +=
                "\nüìÑ PDF Content Error:\n- PDF files appear to be empty or corrupted\n- Verify PDFs contain readable content\n- Try with different PDF files";
            } else {
              errorMessage +=
                "\nüìù Input Error:\n- Check file format and content\n- Ensure files are valid PDFs\n- Try with smaller files first";
            }
          }
        } else if (
          error.name === "TypeError" &&
          error.message.includes("fetch")
        ) {
          errorMessage +=
            "\nüåê Network error\n- Check if backend is running on localhost:8000\n- Verify CORS settings\n- Check firewall/antivirus blocking";
        }

        return errorMessage;
      }

      async function updateConfig() {
        const config = {
          MODEL: document.getElementById("model").value,
          START: parseInt(document.getElementById("startLecture").value),
          NUM_LECS: parseInt(document.getElementById("numLectures").value),
          GET_TRANSCRIPTS: document.getElementById("getTranscripts").checked,
          GET_Q_AND_A: document.getElementById("getQA").checked,
          GET_KEY_POINTS: document.getElementById("getKeyPoints").checked,
          IS_BOOK: document.getElementById("isBook").checked,
        };

        addDebugLog("Updating configuration...", config);

        try {
          const response = await fetch(`${API_BASE}/update-config`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(config),
          });

          if (response.ok) {
            const result = await response.json();
            addDebugLog("‚úÖ Configuration updated successfully", result);
            showStatus("success", "Configuration updated successfully!");
          } else {
            const errorData = await response
              .json()
              .catch(() => ({ detail: "Unknown error" }));
            throw new Error(
              errorData.detail || "Failed to update configuration"
            );
          }
        } catch (error) {
          const errorMessage = handleApiError(
            error,
            null,
            "Configuration Update"
          );
          showStatus("error", errorMessage);
        }
      }

      async function processCompletePipeline() {
        if (uploadedFiles.length === 0) {
          showStatus("error", "Please upload at least one PDF file.");
          return;
        }

        // Update config first
        await updateConfig();

        const formData = new FormData();
        uploadedFiles.forEach((file) => {
          formData.append("files", file);
        });
        formData.append(
          "max_concurrent",
          document.getElementById("maxConcurrent").value
        );

        showLoading(true);
        hideStatus();
        hideResults();

        try {
          const response = await fetch(
            `${API_BASE}/process-complete-pipeline`,
            {
              method: "POST",
              body: formData,
            }
          );

          if (response.ok) {
            const result = await response.json();
            showStatus(
              "success",
              `Processing completed! ${result.processed_count} lectures processed.`
            );
            displayResults(result);
          } else {
            const errorData = await response.json();
            throw new Error(errorData.detail || "Processing failed");
          }
        } catch (error) {
          const errorMessage = handleApiError(
            error,
            null,
            "Complete Pipeline Processing"
          );
          showStatus("error", errorMessage);
        } finally {
          showLoading(false);
        }
      }

      // Step-by-Step Processing Functions
      async function mergePdfs() {
        if (uploadedFiles.length === 0) {
          showStatus("error", "Please upload at least one PDF file.");
          return;
        }

        addDebugLog("Starting PDF merge process...", {
          fileCount: uploadedFiles.length,
          files: uploadedFiles.map((f) => ({
            name: f.name,
            size: f.size,
            type: f.type,
            lastModified: new Date(f.lastModified).toISOString(),
          })),
        });

        const formData = new FormData();
        uploadedFiles.forEach((file, index) => {
          formData.append("files", file);
          addDebugLog(
            `Added file ${index + 1}/${uploadedFiles.length} to form data: ${
              file.name
            }`
          );
        });

        showLoading(true);
        hideStatus();

        try {
          addDebugLog("Sending merge request to API...");
          const response = await fetch(`${API_BASE}/merge-pdfs`, {
            method: "POST",
            body: formData,
          });

          addDebugLog("Merge API response received", {
            status: response.status,
            statusText: response.statusText,
          });

          if (response.ok) {
            const result = await response.json();
            addDebugLog("‚úÖ PDF merge successful", result);

            // Store the merged PDF data (in a real app, you'd get the PDF bytes)
            mergedPdfData = {
              pageCount: result.page_count,
              bookmarkCount: result.bookmark_count,
              timestamp: new Date().toISOString(),
            };

            showStatus(
              "success",
              `‚úÖ PDFs merged successfully! ${result.page_count} pages, ${result.bookmark_count} bookmarks.`
            );
            updateProcessButton();
          } else {
            const errorData = await response
              .json()
              .catch(() => ({ detail: "Unknown error" }));
            throw new Error(errorData.detail || "Merge failed");
          }
        } catch (error) {
          const errorMessage = handleApiError(error, null, "PDF Merge");
          showStatus("error", errorMessage);
        } finally {
          showLoading(false);
        }
      }

      async function extractContent() {
        if (!mergedPdfData) {
          showStatus("error", "Please merge PDFs first.");
          return;
        }

        addDebugLog("Starting content extraction...", mergedPdfData);

        // For demo purposes, we'll simulate using the first uploaded file
        // In a real implementation, you'd use the actual merged PDF
        const formData = new FormData();
        formData.append("file", uploadedFiles[0]);

        showLoading(true);
        hideStatus();

        try {
          addDebugLog("Sending extract content request to API...");
          const response = await fetch(`${API_BASE}/extract-content`, {
            method: "POST",
            body: formData,
          });

          addDebugLog("Extract content API response received", {
            status: response.status,
            statusText: response.statusText,
          });

          if (response.ok) {
            const result = await response.json();
            addDebugLog("‚úÖ Content extraction successful", {
              lectureCount: result.lecture_count,
              firstLecture: result.lectures[0]
                ? result.lectures[0].title
                : "None",
            });

            extractedLectures = result.lectures;

            showStatus(
              "success",
              `‚úÖ Content extracted successfully! Found ${result.lecture_count} lectures.`
            );
            updateProcessButton();
          } else {
            const errorData = await response
              .json()
              .catch(() => ({ detail: "Unknown error" }));
            throw new Error(errorData.detail || "Content extraction failed");
          }
        } catch (error) {
          const errorMessage = handleApiError(
            error,
            null,
            "Content Extraction"
          );
          showStatus("error", errorMessage);
        } finally {
          showLoading(false);
        }
      }

      async function processWithAI() {
        if (!extractedLectures) {
          showStatus("error", "Please extract content first.");
          return;
        }

        addDebugLog("Starting AI processing...", {
          lectureCount: extractedLectures.length,
          lectures: extractedLectures.map((l) => ({
            index: l.index,
            title: l.title,
          })),
        });

        // Update config first
        await updateConfig();

        const formData = new FormData();
        formData.append("lectures_json", JSON.stringify(extractedLectures));
        formData.append(
          "max_concurrent",
          document.getElementById("maxConcurrent").value
        );

        showLoading(true);
        hideStatus();
        hideResults();

        try {
          addDebugLog("Sending AI processing request to API...");
          const response = await fetch(`${API_BASE}/process-lectures`, {
            method: "POST",
            body: formData,
          });

          addDebugLog("AI processing API response received", {
            status: response.status,
            statusText: response.statusText,
          });

          if (response.ok) {
            const result = await response.json();
            addDebugLog("‚úÖ AI processing successful", {
              totalCost: result.total_cost,
              processedCount: result.processed_count,
            });

            showStatus(
              "success",
              `‚úÖ AI processing completed! ${
                result.processed_count
              } lectures processed for $${result.total_cost.toFixed(4)}.`
            );
            displayResults(result);
          } else {
            const errorData = await response
              .json()
              .catch(() => ({ detail: "Unknown error" }));
            throw new Error(errorData.detail || "AI processing failed");
          }
        } catch (error) {
          const errorMessage = handleApiError(error, null, "AI Processing");
          showStatus("error", errorMessage);
        } finally {
          showLoading(false);
        }
      }

      function showDebugInfo() {
        const debugDiv = document.getElementById("debugInfo");
        const debugContent = document.getElementById("debugContent");

        let debugText = "=== DEBUG INFORMATION ===\n\n";
        debugText += `Timestamp: ${new Date().toLocaleString()}\n`;
        debugText += `API Base URL: ${API_BASE}\n`;
        debugText += `Uploaded Files: ${uploadedFiles.length}\n`;
        debugText += `Merged PDF Data: ${
          mergedPdfData ? "Available" : "Not available"
        }\n`;
        debugText += `Extracted Lectures: ${
          extractedLectures ? extractedLectures.length : "Not available"
        }\n\n`;

        debugText += "=== CURRENT STATE ===\n";
        debugText += `Files: ${uploadedFiles.map((f) => f.name).join(", ")}\n`;
        if (mergedPdfData) {
          debugText += `Merged PDF: ${mergedPdfData.pageCount} pages, ${mergedPdfData.bookmarkCount} bookmarks\n`;
        }
        if (extractedLectures) {
          debugText += `Lectures: ${extractedLectures
            .map((l) => `${l.index}. ${l.title}`)
            .join(", ")}\n`;
        }
        debugText += "\n";

        debugText += "=== DEBUG LOG ===\n";
        debugText += debugLog.join("\n");

        debugContent.textContent = debugText;
        debugDiv.style.display = "block";

        // Scroll to debug section
        debugDiv.scrollIntoView({ behavior: "smooth" });
      }

      function displayResults(result) {
        const resultsDiv = document.getElementById("results");
        const costInfo = document.getElementById("costInfo");
        const resultsList = document.getElementById("resultsList");

        // Show cost information
        costInfo.innerHTML = `
                üí∞ Total Cost: $${result.total_cost.toFixed(4)} | 
                üìö Processed: ${result.processed_count} lectures |
                <a href="#" onclick="viewTempFiles(); return false;" style="color: #007bff; text-decoration: none;">üìÅ View Generated Files</a>
            `;

        // Display results
        resultsList.innerHTML = result.results
          .map(
            (lecture) => `
                <div class="result-item">
                    <div class="result-header">
                        üìñ Lecture ${lecture.index}: ${lecture.title}
                        <span style="float: right; font-size: 0.9em; color: #666;">
                            Cost: $${lecture.cost.toFixed(4)}
                        </span>
                    </div>
                    <div class="result-content">
                        <div style="margin-bottom: 20px;">
                            <strong>üìù Study Notes:</strong><br>
                            ${lecture.study_notes.substring(0, 500)}${
              lecture.study_notes.length > 500 ? "..." : ""
            }
                        </div>
                        ${
                          lecture.transcript
                            ? `
                        <div style="margin-bottom: 20px;">
                            <strong>üé§ Transcript:</strong><br>
                            ${lecture.transcript.substring(0, 300)}${
                                lecture.transcript.length > 300 ? "..." : ""
                              }
                        </div>
                        `
                            : ""
                        }
                        ${
                          lecture.questions
                            ? `
                        <div style="margin-bottom: 20px;">
                            <strong>‚ùì Questions:</strong><br>
                            ${lecture.questions.substring(0, 300)}${
                                lecture.questions.length > 300 ? "..." : ""
                              }
                        </div>
                        `
                            : ""
                        }
                        ${
                          lecture.key_points
                            ? `
                        <div>
                            <strong>üéØ Key Points:</strong><br>
                            ${lecture.key_points.substring(0, 300)}${
                                lecture.key_points.length > 300 ? "..." : ""
                              }
                        </div>
                        `
                            : ""
                        }
                    </div>
                </div>
            `
          )
          .join("");

        resultsDiv.style.display = "block";

        // Save results to downloadable file
        const blob = new Blob([JSON.stringify(result, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const downloadLink = document.createElement("a");
        downloadLink.href = url;
        downloadLink.download = "lecture_results.json";
        downloadLink.textContent = "üíæ Download Full Results";
        downloadLink.style.display = "inline-block";
        downloadLink.style.marginTop = "10px";
        downloadLink.style.padding = "10px 15px";
        downloadLink.style.background = "#4facfe";
        downloadLink.style.color = "white";
        downloadLink.style.textDecoration = "none";
        downloadLink.style.borderRadius = "5px";

        costInfo.appendChild(downloadLink);
      }

      function clearResults() {
        document.getElementById("results").style.display = "none";
        document.getElementById("debugInfo").style.display = "none";
        document.getElementById("tempFiles").style.display = "none";
        uploadedFiles = [];
        mergedPdfData = null;
        extractedLectures = null;
        debugLog = [];
        updateFileList();
        updateProcessButton();
        hideStatus();
        addDebugLog("üóëÔ∏è All data cleared");
      }

      // Utility functions
      function showStatus(type, message) {
        const statusDiv = document.getElementById("statusMessage");
        statusDiv.className = `status ${type}`;
        statusDiv.textContent = message;
        statusDiv.style.display = "block";

        // Auto-hide success messages after 5 seconds
        if (type === "success") {
          setTimeout(() => {
            hideStatus();
          }, 5000);
        }
      }

      function hideStatus() {
        document.getElementById("statusMessage").style.display = "none";
      }

      function showLoading(show) {
        document.getElementById("loading").style.display = show
          ? "block"
          : "none";
      }

      function hideResults() {
        document.getElementById("results").style.display = "none";
      }

      // Temp files functions
      async function viewTempFiles() {
        try {
          const response = await fetch(`${API_BASE}/temp-files`);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          displayTempFiles(result.files);
        } catch (error) {
          showStatus("error", `Error fetching temp files: ${error.message}`);
          addDebugLog(`‚ùå Error fetching temp files: ${error.message}`);
        }
      }

      function displayTempFiles(files) {
        const tempFilesDiv = document.getElementById("tempFiles");
        const tempFilesList = document.getElementById("tempFilesList");

        if (!files || files.length === 0) {
          tempFilesList.innerHTML =
            '<p style="color: #666; text-align: center; padding: 20px;">No files found in temp directory</p>';
        } else {
          tempFilesList.innerHTML = files
            .sort((a, b) => b.created - a.created) // Sort by creation time, newest first
            .map(
              (file) => `
              <div class="file-item">
                <div class="file-info">
                  <div class="file-name">üìÑ ${file.name}</div>
                  <div class="file-meta">
                    Size: ${formatFileSize(file.size)} | 
                    Created: ${new Date(file.created * 1000).toLocaleString()}
                  </div>
                </div>
                <div class="file-actions">
                  ${
                    file.name.endsWith(".md") || file.name.endsWith(".json")
                      ? `<button class="btn-file btn-view" onclick="viewFileContent('${file.name}')">üëÅÔ∏è View</button>`
                      : ""
                  }
                  <a href="${API_BASE}/temp-files/${file.name}" 
                     target="_blank" 
                     class="btn-file btn-download">üíæ Download</a>
                </div>
              </div>
            `
            )
            .join("");
        }

        tempFilesDiv.style.display = "block";
        // Hide other sections
        document.getElementById("results").style.display = "none";
        document.getElementById("debugInfo").style.display = "none";
      }

      async function viewFileContent(filename) {
        try {
          const response = await fetch(
            `${API_BASE}/temp-files/${filename}/content`
          );
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();
          displayFileContent(filename, result.content, result.type);
        } catch (error) {
          showStatus("error", `Error viewing file: ${error.message}`);
          addDebugLog(`‚ùå Error viewing file ${filename}: ${error.message}`);
        }
      }

      function displayFileContent(filename, content, type) {
        const fileViewer = document.getElementById("fileViewer");
        const viewerTitle = document.getElementById("viewerTitle");
        const fileContent = document.getElementById("fileContent");

        viewerTitle.textContent = `üìÑ ${filename}`;

        if (type === "markdown") {
          // Simple markdown rendering (basic formatting)
          const htmlContent = content
            .replace(/^# (.*$)/gim, "<h1>$1</h1>")
            .replace(/^## (.*$)/gim, "<h2>$1</h2>")
            .replace(/^### (.*$)/gim, "<h3>$1</h3>")
            .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
            .replace(/\*(.*?)\*/g, "<em>$1</em>")
            .replace(/^\* (.*$)/gim, "<li>$1</li>")
            .replace(/\n\n/g, "</p><p>")
            .replace(/^(?!<[h|l|p])/gm, "<p>")
            .replace(/(?<![h|i]>)$/gm, "</p>")
            .replace(/<p><\/p>/g, "")
            .replace(/(<li>.*<\/li>)/gs, "<ul>$1</ul>")
            .replace(/<\/li>\s*<li>/g, "</li><li>");

          fileContent.innerHTML = `<div class="markdown-content">${htmlContent}</div>`;
        } else if (type === "json") {
          // Pretty print JSON
          try {
            const jsonObj = JSON.parse(content);
            fileContent.innerHTML = `<pre style="font-family: 'Courier New', monospace; font-size: 0.9em;">${JSON.stringify(
              jsonObj,
              null,
              2
            )}</pre>`;
          } catch (e) {
            fileContent.innerHTML = `<pre style="font-family: 'Courier New', monospace; font-size: 0.9em;">${content}</pre>`;
          }
        } else {
          fileContent.innerHTML = `<pre style="font-family: 'Courier New', monospace; font-size: 0.9em;">${content}</pre>`;
        }

        fileViewer.style.display = "block";
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }
    </script>
  </body>
</html>
